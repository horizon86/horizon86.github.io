<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>使用v2ray和华为云实现校园网ipv6免流方案</title>
<link href='../../assets/css/typroa-base-link.css' rel='stylesheet' type='text/css' />
<link href='../../assets/css/typroa-base.css' rel='stylesheet' type='text/css' />
<link href='../../assets/css/typroa-github.css' rel='stylesheet' type='text/css' />
<link rel="shortcut icon" href="../../favicon.ico">

</head>
<body class='typora-export os-windows'>
<div id='write'  class=''><blockquote><p><span>本文使用无ipv4的网络环境发布</span>
<span>重点：本文无任何违反政治法律、无任何与翻墙有关的内容</span></p></blockquote><h1><a name="前言" class="md-header-anchor"></a><span>前言</span></h1><p><span>这学期我们有一门课，华为云给赞助了300元代金券，本来是供我们做云服务的实验用的。偶然发现可以使用ipv6，公测期间ipv6免费，便想着能否搞个ipv6免流玩一玩（虽然疫情期间校园网流量免费）。</span></p><h1><a name="工具准备" class="md-header-anchor"></a><span>工具准备</span></h1><ol start='' ><li><span>能够完成正常操作的人</span></li><li><span>v2ray软件（windows端的v2ray，windows端的v2rayN，以及linux端的v2ray）</span></li></ol><h1><a name="原理介绍" class="md-header-anchor"></a><span>原理介绍</span></h1><p><span>接下来的部分是理论知识介绍，有兴趣的可以看看，无兴趣的可以直接跳转到随后的：</span><a href='#操作步骤'><span>操作步骤</span></a></p><p><span>v2ray在本地开启代理服务器，并将流量通过ipv6统统转发到华为云上，华为云使用ipv4访问后将结果回传给本机。其中有些详细原理我也没有很搞清楚，因此下面的介绍不保证正确性，但配置之后确实可以成功。</span></p><p><span>v2ray软件的原理是定义多个入口和多个出口，入口接收到数据包后根据路由策略从不同的出口发送出去。因此我们的做法是：本地开启一个v2ray程序，将本地所有流量发送到到v2ray的入口，v2ray将流量通过ipv6出口发送给华为云；华为云上也运行一个v2ray，入口接收本地的出口流量，将流量通过华为云的ipv4转发到真正的目的地。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;浏览器&gt;---socks--&lt;v2ray inbound&gt;-&lt;v2ray ipv6 outbound&gt;---vmess---&lt;华为云ipv6&gt;-&lt;华为云内部转换ipv6 to ipv 4&gt;-&lt;华为云 v2ray inbound&gt;--&lt;华为云v2ray outbound&gt;---dircet---&lt;真正的服务器&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>本地的v2ray入口采用socks协议，出口使用vmess协议，华为云上v2ray入口使用vmess协议，出口直连。</span></p><p><span>有细心的小伙伴就要问了：v2ray是怎么转发的呀？是直接在源数据包上修改吗？socks协议具体是什么呀？其实我也不清楚，有空的话再学。</span></p><h1><a name="操作步骤" class="md-header-anchor"></a><span>操作步骤</span></h1><h2><a name="1-购买华为云服务器和ip" class="md-header-anchor"></a><span>1. 购买华为云服务器和ip</span></h2><ul><li><span>在华为云创建一个包含ipv6的虚拟子网（VPC），跟着官网提示来即可，无难度</span></li><li><span>购买一个弹性公网ip，按需计费（土豪随意），按流量计费，带宽100Mbps。选择按流量计费后带宽不影响费用。</span>
<span>最重要的是勾选一键开启ipv6</span>
<img src="../../assets/img/blogs/2/1.png" referrerpolicy="no-referrer" alt="在这里插入图片描述"></li><li><span>购买一台华为云ECS，建议选择x86架构（其他需要对应的v2ray版本）。性能无所谓，最垃圾的就行。不要购买公网ip，随后绑定刚刚买的ip即可。</span></li></ul><h2><a name="2-华为云安装v2ray" class="md-header-anchor"></a><span>2. 华为云安装v2ray</span></h2><p><span>使用ssh工具连接到华为云服务器，参照</span><a href='https://github.com/v2fly/fhs-install-v2ray/blob/master/README.zh-Hans-CN.md'><span>这里</span></a><span>安装v2ray。如果华为云访问GitHub不利索，那么自己下载相关文件再上传就行，脚本这里改一下：</span>
<img src="../../assets/img/blogs/2/2.png" referrerpolicy="no-referrer" alt="在这里插入图片描述"></p><p><span>安装成功后，先等待一会，我们来制作两个配置文件。</span></p><h2><a name="3-配置文件" class="md-header-anchor"></a><span>3. 配置文件</span></h2><p><span>v2ray的配置文件是json格式的，服务器设置如下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="json" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"inbounds"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"port"</span>: <span class="cm-number">8088</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"protocol"</span>: <span class="cm-string">"vmess"</span>, &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"settings"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"clients"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"id"</span>: <span class="cm-string">"edc33434-77a4-b150-4912-5d55251a39d5"</span>, &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"alterId"</span>: <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"sniffing"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"enabled"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"destOverride"</span>: [<span class="cm-string">"http"</span>, <span class="cm-string">"tls"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"outbounds"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"tag"</span>:<span class="cm-string">"IP4_out"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"protocol"</span>: <span class="cm-string">"freedom"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"settings"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"domainStrategy"</span>: <span class="cm-string">"UseIPv4"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"routing"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"rules"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"type"</span>: <span class="cm-string">"field"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"outboundTag"</span>: <span class="cm-string">"IP4_out"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"network"</span>: <span class="cm-string">"udp,tcp"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 851px;"></div><div class="CodeMirror-gutters" style="display: none; height: 851px;"></div></div></div></pre><ul><li><span>inbounds.seeting.clients.id:是一个UUID，请使用在线网站或者工具生成，别瞎编，你编的很可能不符合格式要求</span></li><li><span>alterID：额外id，建议设置在60-100，数字越大服务器压力越大，我这里是1，也没啥事。</span></li></ul><p><span>将文件保存为config.json并放在</span><code>/usr/local/etc/v2ray/</code><span>文件夹下</span>
<span>执行</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl enable v2ray</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl <span class="cm-builtin">start</span> v2ray</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>服务器配置就结束了。</span>
<span>本地打开v2rayN，选择添加VMess服务器</span>
<img src="../../assets/img/blogs/2/3.png" referrerpolicy="no-referrer" alt="在这里插入图片描述">
<span>配置完成后，设置为全局代理，并将网卡ipv4禁用，测试一下！</span>
<span>看biibili网速还行：</span>
<img src="../../assets/img/blogs/2/4.png" referrerpolicy="no-referrer" alt="在这里插入图片描述"></p><p>&nbsp;</p></div>
</body>
</html>